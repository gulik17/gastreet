!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}({0:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e){var t=[],n=Object.assign({},s,e);n.messageId&&t.push(l["default"].messageStatus(n.messageId,d.DELIVERED));var r={body:n.body,icon:n.icon,tag:"my-tag",data:n};return["image","progress","actions"].forEach(function(e){n[e]&&(r[e]=n[e])}),n.requireInteraction&&(r.requireInteraction=!0),t.push(self.registration.showNotification(n.title,r)),Promise.all(t)}var i=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(6),c=r(a),f=n(35),l=r(f),s={title:"Новое сообщение",body:"Новое сообщение",icon:"",url:""},d={DELIVERED:"delivered",SEEN:"seen",CLOSED:"closed"},p=function(){function e(){o(this,e)}return i(e,[{key:"push",value:function(e){if(e.data){c["default"].debug("Push",e.data.text());var t=void 0;try{t=e.data?JSON.parse(e.data.text()):{}}catch(n){t={}}e.waitUntil(u(t))}else e.waitUntil(l["default"].getMesaageForCurrentDevice().then(function(e){c["default"].debug("Data FROM API",e),e.forEach(function(e){return u(e)})}))}},{key:"close",value:function(e){c["default"].debug("close",e),e.notification.data.messageId&&e.waitUntil(l["default"].messageStatus(e.notification.data.messageId,d.CLOSED))}},{key:"click",value:function(e){c["default"].debug("click",e);var t=e.notification.data.url;e.notification.close(),e.action&&e.notification.data.actions&&e.notification.data.actions.forEach(function(n){n.action===e.action&&(t=n.url?n.url.replace("%ACTION%",n.action):t?t.replace("%ACTION%",n.action):t)});var n=[];e.notification.data.messageId&&n.push(l["default"].messageStatus(e.notification.data.messageId,d.SEEN)),n.push(clients.matchAll({type:"window"}).then(function(e){for(var n=void 0,r=0;e.length>r;r++){var o=e[r];if("/"===o.url&&"focus"in o){n=o.focus();break}}return clients.openWindow&&t&&(n=clients.openWindow(t)),n})),e.waitUntil(Promise.all(n))}},{key:"install",value:function(e){c["default"].debug("install",e),e.waitUntil(self.skipWaiting())}},{key:"activate",value:function(e){c["default"].debug("activate",e),e.waitUntil(self.clients.claim())}},{key:"subscriptionChange",value:function(e){c["default"].debug("subscriptionChange",e)}}]),e}(),v=new p;self.addEventListener("push",function(e){return v.push(e)}),self.addEventListener("notificationclick",function(e){return v.click(e)}),self.addEventListener("notificationclose",function(e){return v.close(e)}),self.addEventListener("install",function(e){return v.install(e)}),self.addEventListener("activate",function(e){return v.activate(e)}),self.addEventListener("pushsubscriptionchange",function(e){return v.subscriptionChange(e)}),self.addEventListener("fetch",function(e){c["default"].debug(e.request.url)})},6:function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=function(){function e(){r(this,e)}return o(e,null,[{key:"debug",value:function(){}},{key:"info",value:function(){var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);e=["[INFO] ViaPush: "].concat(e),console.info.apply(console,e)}},{key:"error",value:function(){var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);e=["[ERROR] ViaPush: "].concat(e),console.error.apply(console,e)}},{key:"warn",value:function(){var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);e=["[WARNING] ViaPush: "].concat(e),console.warn.apply(console,e)}}]),e}();t["default"]=u},20:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(t.DB_NAME_OLD="__ViaPush",t.DB_NAME="__viapush__"),o=(t.DB_VERSION=2,t.WORKER_PATH="/ViaPushWorker.js",t.BASE_API_URL="//api.viapush.com/public",t.LOCAL_STORAGE_KEY_DEVICE=r+"_dvc",t.POPUP_STYLE_LINK="//cdn.viapush.com/cdn/v1/sdks/widget.css",t.PERMISSION_DEFAULT=1),u=t.PERMISSION_DEFAULT_STRING="default",i=t.PERMISSION_GRANTED=2,a=t.PERMISSION_GRANTED_STRING="granted",c=t.PERMISSION_DENIED=3,f=t.PERMISSION_DENIED_STRING="denied",l=t.PERMISSION_STRING_TO_NUMBER={};l[u]=o,l[a]=i,l[f]=c},35:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(20),a=n(83),c=r(a),f=n(64),l=r(f),s=n(6),d=r(s),p=function(e,t,n){var r=i.BASE_API_URL+e,o={method:t,headers:{"Content-Type":"text/plain;charset=UTF-8"}};return n&&(o.body=JSON.stringify(n)),fetch(r,o).then(function(e){return e.json()}).then(function(e){if(!~[200,201].indexOf(e.code))throw new c["default"](e.code,r,o);return e})},v=function(){function e(){o(this,e)}return u(e,null,[{key:"createDevice",value:function(e){return p("/devices","POST",{applicationId:e,domain:window.location.hostname}).then(function(e){return e.data})}},{key:"updateDevice",value:function(e,t){return p("/devices/"+e.id+"?k="+e.accessToken,"POST",t).then(function(e){return e.data})["catch"](function(t){"Api request return error NOT_FOUND."===t.message&&(d["default"].info("reCreateDevice",t),l["default"].create(e.applicationId,!0).then(function(e){d["default"].info("reCreateDevice",e)}))})}},{key:"messageStatus",value:function(e,t){return l["default"].get().then(function(n){return p("/messages/"+e+"/"+t+"?k="+n.accessToken,"GET")})}},{key:"migration",value:function(e){return p("/devices/migration","POST",e).then(function(e){return e.data})}},{key:"getSubDomain",value:function(){return p("/applications/sub","GET").then(function(e){return e.data})}},{key:"addToAudience",value:function(e,t){return p("/devices/"+t.id+"/audiences/"+e+"?k="+t.accessToken,"POST")}},{key:"addConversion",value:function(e,t){return p("/devices/"+t.id+"/conversions/"+e,"GET")}},{key:"settings",value:function(e){return p("/applications/"+e+"/settings","GET").then(function(e){return e.data})}},{key:"bellStat",value:function(e,t){return p("/applications/"+e+"/bell?action="+t,"GET")}},{key:"getMesaageForCurrentDevice",value:function(){return l["default"].get().then(function(e){return p("/devices/"+e.id+"/messages?k="+e.accessToken,"GET").then(function(e){return e.data})})}}]),e}();t["default"]=v},36:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=n(112),c=r(a),f=function(e){function t(){return o(this,t),u(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return i(t,e),t}(c["default"]);t["default"]=f},56:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(84),a=r(i),c=n(81),f=r(c),l=n(82),s=r(l),d=n(6),p=r(d),v=new f["default"],y=new s["default"];if(!v.supported&&!y.supported)throw new a["default"];var b=function(){function e(){o(this,e)}return u(e,null,[{key:"getDevice",value:function(){return v.supported?v.getDevice():y.getDevice()}},{key:"createDevice",value:function(e){p["default"].debug("Storage: createDevice ",e);var t=[];return[v,y].forEach(function(n){p["default"].debug("Storage: createDevice provider ",n),n.supported&&t.push(n.createDevice(e))}),Promise.all(t).then(function(e){return e[0]})}},{key:"updateDevice",value:function(e){var t=[];return[v,y].forEach(function(n){n.supported&&t.push(n.updateDevice(e))}),Promise.all(t).then(function(e){return e[0]})}},{key:"replaceLocal",value:function(e){var t=[];return[v,y].forEach(function(n){n.supported&&t.push(n.replaceDevice(e))}),Promise.all(t).then(function(e){return e[0]})}}]),e}();t["default"]=b},57:function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function o(){var e=this;n(this,o),this.supported=!1,this.ready=!1,this.db={},["getDevice","createDevice","updateDevice"].forEach(function(t){if(void 0===e[t])throw new TypeError("Method "+t+" undefined, method must return Promise")})};t["default"]=r},64:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(35),a=r(i),c=n(56),f=r(c),l=n(6),s=r(l),d={DEFAULT:1,GRANTED:2,DENIED:3},p=function(){function e(){o(this,e)}return u(e,null,[{key:"get",value:function(){return f["default"].getDevice()}},{key:"create",value:function(e,t){return s["default"].debug("Device: create new device with appId: ",e),a["default"].createDevice(e).then(function(e){return t?f["default"].replaceLocal(e):f["default"].createDevice(e)})}},{key:"getOrCreate",value:function(t){return s["default"].debug("Device: getOrCreate device with appId: ",t),e.get().then(function(n){return n||e.create(t)})}},{key:"createLocal",value:function(e){return f["default"].createDevice(e)}},{key:"updateLocal",value:function(e){return s["default"].debug("Device: update device",e),f["default"].getDevice().then(function(t){if(!t)throw Error("Device: try update, by device not found");return f["default"].updateDevice(e)})}},{key:"replaceLocal",value:function(e){return f["default"].replaceLocal(e)}},{key:"update",value:function(e){return s["default"].debug("Device: update device",e),f["default"].getDevice().then(function(t){if(!t)throw Error("Device: try update, by device not found");return a["default"].updateDevice(t,e)}).then(f["default"].updateDevice).then(function(e){return e})}},{key:"migration",value:function(e){return s["default"].debug("Device: start migration",e),a["default"].migration(e).then(f["default"].createDevice)}},{key:"addToAudience",value:function(e){return f["default"].getDevice().then(function(t){if(!t)throw Error("Device: try addToAudience, by device not found");return a["default"].addToAudience(e,t)})}},{key:"addConversion",value:function(e){return f["default"].getDevice().then(function(t){if(!t)throw Error("Device: try addToAudience, by device not found");return a["default"].addConversion(e,t)})}},{key:"updateData",value:function(e){return f["default"].getDevice().then(function(t){if(!t)throw Error("Device: try addToAudience, by device not found");return a["default"].updateDevice(t,{data:e})})}},{key:"PERMISSIONS",get:function(){return d}}]),e}();t["default"]=p},81:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(20),f=n(6),l=r(f),s=n(57),d=r(s),p=function(e){function t(){o(this,t);var e=u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.supported=!!indexedDB,e}return i(t,e),a(t,[{key:"createConnection",value:function(){return new Promise(function(e,t){var n=function(){var n=indexedDB.open(c.DB_NAME,c.DB_VERSION),r=function(t){var n=t.target.result;e(n)},o=function(e){t(e)},u=function(e){e.currentTarget.result.createObjectStore("device",{keyPath:"id"})};n.onsuccess=r,n.onerror=o,n.onupgradeneeded=u};n()})}},{key:"getDevice",value:function(){return this.createConnection().then(function(e){return l["default"].debug("IndexedDBProvider: getDevice()"),new Promise(function(t,n){var r=e.transaction(["device"]).objectStore("device").getAll();r.onerror=function(){n("IndexedDBProvider, Can`t get device from IndexedDb")},r.onsuccess=function(e){t(e.target.result[0])}})})}},{key:"createDevice",value:function(e){var t=this;return this.getDevice().then(function(n){var r=void 0;return r=n?n:t.createConnection().then(function(t){return l["default"].debug("IndexedDBProvider: createDevice",e),new Promise(function(n,r){var o=t.transaction(["device"],"readwrite").objectStore("device").add(e);o.onsuccess=function(){n(e)},o.onerror=function(){r("Device: Can`t create device in IndexedDb")}})})})}},{key:"updateDevice",value:function(e){var t=this;return this.createConnection().then(function(n){return l["default"].debug("IndexedDBProvider: updateDevice",e),t.getDevice().then(function(t){return new Promise(function(r,o){delete e.accessToken;var u=n.transaction(["device"],"readwrite").objectStore("device").put(Object.assign(t,e));u.onsuccess=function(){r(t)},u.onerror=function(){o("Device: Can`t update device in IndexedDb")}})})})}},{key:"replaceDevice",value:function(e){var t=this;return this.createConnection().then(function(e){return new Promise(function(t,n){var r=e.transaction(["device"],"readwrite").objectStore("device").clear();r.onsuccess=function(){t()},r.onerror=function(){n("Device: Can`t update device in IndexedDb")}})}).then(function(){return t.createDevice(e)})}}]),t}(d["default"]);t["default"]=p},82:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(20),f=n(57),l=r(f),s=n(6),d=r(s),p=function(e){function t(){o(this,t);var e=u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));try{localStorage.setItem("test","test"),localStorage.removeItem("test"),e.supported=!0}catch(n){e.supported=!1}return e.ready=e.supported,e.db=e.supported?localStorage:void 0,e}return i(t,e),a(t,[{key:"getDevice",value:function(){var e=this;return d["default"].debug("LocalStorageProvider: getDevice"),new Promise(function(t){var n=e.db.getItem(c.LOCAL_STORAGE_KEY_DEVICE);if(n){try{n=JSON.parse(n)}catch(r){n=null}n?t(n):t()}else t()})}},{key:"createDevice",value:function(e){var t=this;return d["default"].debug("LocalStorageProvider: createDevice",e),new Promise(function(n){t.db.setItem(c.LOCAL_STORAGE_KEY_DEVICE,JSON.stringify(e)),n(e)})}},{key:"updateDevice",value:function(e){var t=this;return d["default"].debug("LocalStorageProvider: updateDevice",e),this.getDevice().then(function(n){delete e.accessToken,t.createDevice(Object.assign(n||{},e))})}},{key:"replaceDevice",value:function(e){return this.createDevice(e)}}]),t}(l["default"]);t["default"]=p},83:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(36),f=r(c),l=function(e){function t(e){return o(this,t),u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Api request return error "+e+"."))}return i(t,e),a(t,null,[{key:"AUTHENTICATION_ERROR",get:function(){return 401}},{key:"NOT_FOUND",get:function(){return 404}},{key:"VALIDATION_ERROR",get:function(){return 422}},{key:"SERVER_ERROR",get:function(){return 500}}]),t}(f["default"]);t["default"]=l},84:function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=n(36),c=r(a),f=function(e){function t(){return o(this,t),u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"IndexedDB and localStorage are not supported."))}return i(t,e),t}(c["default"]);t["default"]=f},112:function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){function t(){e.apply(this,arguments)}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";n(this,t);var o=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return Object.defineProperty(o,"message",{configurable:!0,enumerable:!1,value:e,writable:!0}),Object.defineProperty(o,"name",{configurable:!0,enumerable:!1,value:o.constructor.name,writable:!0}),Error.hasOwnProperty("captureStackTrace")?(Error.captureStackTrace(o,o.constructor),r(o)):(Object.defineProperty(o,"stack",{configurable:!0,enumerable:!1,value:Error(e).stack,writable:!0}),o)}return o(t,e),t}(u(Error));t["default"]=i,e.exports=t["default"]}});
//# sourceMappingURL=sw.js.map