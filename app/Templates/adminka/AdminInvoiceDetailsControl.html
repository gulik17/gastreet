{assign var=this value=$AdminInvoiceDetailsControl}

{loadscript file='/js/jquery.placeholder.min.js' type='js'}
{loadscript file='/js/pages/admininvoicedetails.js' type='js'}

{assign var=type value=$this.pay->type}
{assign var=status value=$this.pay->status}
{assign var=userId value=$this.pay->userId}

<h4>Счёт на оплату номер: {$this.pay->id}</h4>
<dl>
    <dt>Сумма:</dt>
    <dd>{$this.pay->needAmount}</dd>
</dl>
<dl>
    <dt>Дата создания:</dt>
    <dd>{if $this.pay->tsCreated}{$this.pay->tsCreated|dateformat:'d.m.Y, в H:i'}{else}-{/if}</dd>
</dl>

<!-- редактирование реквизитов контрагента -->
<form id="form" action="{alink do=adminsaveuserdetails}" method="post" style="max-width: 400px">
    <input type="hidden" name="id" value="{$this.details->id}" />
    <div class="form-group">
        <label>Компания:</label>
        <input class="form-control" type="text" name="company" id="company" value="{$this.details->company}"/>
    </div>
    <div class="form-group">
        <label>ИНН:</label>
        <input class="form-control" type="text" name="inn" id="inn" value="{$this.details->inn}"/>
    </div>
    <div class="form-group">
        <label>КПП:</label>
        <input class="form-control" type="text" name="kpp" id="kpp" value="{$this.details->kpp}"/>
    </div>
    <div class="form-group">
        <input class="btn btn-primary" type="submit" value="Сохранить"/>
    </div>
</form>

{if !$this.pay->payAmount && $status != 'STATUS_PAID' && $type == 'TYPE_INVOICE'}
    <div class="well" style="max-width: 400px">
        <h4>Отметить что счёт оплачен:</h4>
        <form method="post" action="{alink do=invoicepayed}">
            <input type="hidden" name="id" value="{$this.pay->id}"/>
            <div class="filter-buyers">
                <div class="form-group">
                    <label class="">Фактическая сумма безналом:</label>
                    <input class="form-control" type="text" name="amount" value="{$this.pay->needAmount|round0}" />
                </div>

                <div class="form-group form-inline">
                    <label style="display:block;">Дата оплаты:</label>
                    <input class="form-control" type="text" name="startDay" placeholder="дд" value="{if $this.startDay != null}{$this.startDay}{/if}" style="width:44px;" /> - 
                    <input class="form-control" type="text" name="startMonth" placeholder="мм" value="{if $this.startMonth != null}{$this.startMonth}{/if}" style="width:44px;" /> - 
                    <input class="form-control" type="text" name="startYear" placeholder="гггг" value="{if $this.startYear != null}{$this.startYear}{/if}" style="width:60px;" />
                </div>
                
                <label style="margin-bottom: 15px;"><input type="checkbox" name="inBalance"/> Зачислить на внутренний баланс</label>
                
                <div class="form-group">
                    <input class="btn btn-success" type="submit" id="submit" value="Отметить что счёт оплачен"/>
                </div>
            </div>
        </form>
    </div>
{/if}

{if $this.invoiceBaskets OR $this.invoiceBasketProducts}
    <h2>Содержимое счёта:</h2>
    <h4>(товары на оплату по счёту):</h4>
{/if}

{if $this.wrongBasket OR $this.wrongBasketProducts}
    <p style="color: red;">Внимание! По данному счёту оплачены позиции, которых уже нет в корзине покупателя!</p>
{/if}

{if $this.invoiceBaskets}
    <h4>Билеты</h4>
    <table class="table table-striped table-bordered table-hover" cellspacing="0" cellpadding="0">
        <tr>
            <th>Билет</th>
            <th>Базовая цена</th>
            <th>Оплачено</th>
        </tr>
        {foreach from=$this.invoiceBaskets item=ticket}
        {assign var=basketId value=$ticket->id}
        {assign var=childid value=$ticket->childId}
        <tr>
            <td>{$ticket->baseTicketName}{if $ticket->childId AND $this.children.$childid} <i>для {$this.children.$childid}</i>{/if}</td>
            <td>{$ticket->needAmount|round0}</td>
            <td>{if $ticket->payAmount+$ticket->ulAmount-$ticket->returnedAmount > $ticket->needAmount-$ticket->discountAmount}<b>{$ticket->payAmount+$ticket->ulAmount-$ticket->returnedAmount}</b>{else}{$ticket->payAmount+$ticket->ulAmount-$ticket->returnedAmount}{/if}</td>
        </tr>
        {/foreach}
    </table>
{/if}

{if $this.invoiceBasketProducts}
<h4>Мастер-классы</h4>
<table class="table table-striped table-bordered table-hover" cellspacing="0" cellpadding="0">
    <tr>
        <th>Наименование</th>
        <th>Базовая цена</th>
        <th>Оплачено</th>
    </tr>
    {foreach from=$this.invoiceBasketProducts item=product}
    {assign var=basketProductId value=$product->id}
    {assign var=childid value=$product->childId}
    <tr>
        <td>{$product->productName}{if $product->childId AND $this.children.$childid} <i>для {$this.children.$childid}</i>{/if}</td>
        <td>{$product->needAmount|round0}</td>
        <td>{if $product->payAmount+$product->ulAmount-$product->returnedAmount > $product->needAmount-$product->discountAmount}<b>{$product->payAmount+$product->ulAmount-$product->returnedAmount}</b>{else}{$product->payAmount+$product->ulAmount-$product->returnedAmount}{/if}</td>
    </tr>
    {/foreach}
</table>
{/if}

<br/>
<h2>Содержимое корзины:</h2>
{assign var=showBronButton value=0}

<div class="gss-basket">
    <h4>Основной участник</h4>
    <div class="user">
        <p>{$this.user->lastname} {$this.user->name} <span class="phone">{$this.user->phone|mobilephone}</span></p>
    </div>
    {if $this.purchasedTickets}
    <table class="table table-striped table-bordered table-hover" cellspacing="0" cellpadding="0">
        <tr>
            <th>Наименование</th>
            <th>Цена</th>
            <th>Оплата</th>
            <th>Скидка</th>
            <th>Статус</th>
            <th>Действия</th>
        </tr>
        {foreach from=$this.purchasedTickets item=ticket}
            {assign var=basketId value=$ticket.id}
            {assign var=basketStatus value=$ticket.status}
            {assign var=basketUserId value=$ticket.userId}
            {assign var=basketChildId value=$ticket.childId}
            {capture name=capturedBasketUserIdChildId}{$basketUserId}_{if $basketChildId}{$basketChildId}{/if}{/capture}
            {assign var=basketUserIdChildId value=$smarty.capture.capturedBasketUserIdChildId}
            <tr>
                <td style="width: 50%;">Билет &laquo;{$ticket.baseTicketName}&raquo;</td>
                <td>{$ticket.needAmount|round0}</td>
                <td>{$ticket.payAmount+$ticket.ulAmount|round0}</td>
                <td>{$ticket.discountAmount|round0}</td>
                <td>{$this.basketStatuses.$basketStatus}</td>
                <td>
                    {if ($ticket.needAmount-$ticket.payAmount-$ticket.ulAmount+$ticket.returnedAmount-$ticket.discountAmount) > 0}
                        {assign var=total value=$total+$ticket.needAmount-$ticket.payAmount-$ticket.ulAmount+$ticket.returnedAmount-$ticket.discountAmount}
                    {/if}
                    {if $basketStatus == 'STATUS_NEW'}<a href="{alink do=adminmarkticketpaid basketId=$basketId}" onclick="return confirm('Вы уверены что нужно отметить эту позицию как оплаченную?');">Отметить что оплачено</a>{else}-{/if}
                </td>
            </tr>
        {/foreach}
    </table>
    {/if}

    {if $this.purchasedProducts}
    <p class="mk-title">Мастер-классы, ужины:</p>
    <table class="table table-striped table-bordered table-hover" cellspacing="0" cellpadding="0">
        <tr>
            <th>Наименование</th>
            <th>Цена</th>
            <th>Оплата</th>
            <th>Скидка</th>
            <th>Статус</th>
            <th>Действия</th>
        </tr>
        {foreach from=$this.purchasedProducts item=product}
            {assign var=basketProductId value=$product.id}
            {assign var=basketStatus value=$product.status}
            {assign var=basketUserId value=$product.userId}
            {assign var=basketChildId value=$product.childId}
            {capture name=capturedBasketUserIdChildId}{$basketUserId}_{if $basketChildId}{$basketChildId}{/if}{/capture}
            {assign var=basketUserIdChildId value=$smarty.capture.capturedBasketUserIdChildId}
            <tr>
                <td style="width: 50%;">{$product.productName}</td>
                <td>{$product.needAmount|round0}</td>
                <td>{$product.payAmount+$product.ulAmount|round0}</td>
                <td>{$product.discountAmount|round0}</td>
                <td>{$this.basketProductStatuses.$basketStatus}</td>
                <td>
                    {if ($product.needAmount-$product.payAmount-$product.ulAmount+$product.returnedAmount-$product.discountAmount) > 0}
                        {assign var=total value=$total+$product.needAmount-$product.payAmount-$product.ulAmount+$product.returnedAmount-$product.discountAmount}
                    {/if}
                    {if $basketStatus == 'STATUS_NEW'}<a href="{alink do=adminmarkproductpaid basketProductId=$basketProductId}" onclick="return confirm('Вы уверены что нужно отметить эту позицию как оплаченную?');">Отметить что оплачено</a>{else}-{/if}
                </td>
            </tr>
        {/foreach}
    </table>
    {/if}

    <br/>

    {assign var=purchasedTickets value=0}
    {assign var=includedProducts value=0}
    {assign var=purchasedProducts value=0}

    {if $this.children}
        {foreach from=$this.children item=child key=childid}
            {assign var=purchasedTickets value=$this.purchasedChildTickets.$childid}
            {assign var=includedProducts value=$this.includedChildProducts.$childid}
            {assign var=purchasedProducts value=$this.purchasedChildProducts.$childid}
            {assign var=gotChildrenBalance value=$this.childrenBalance.$childid}
            <div class="ch-user">
                {$child}
            </div>

            {if !$purchasedTickets && !$purchasedProducts}
                <p class="ch-empty">Корзина данного участника пуста.</p>
            {/if}

            {if $purchasedTickets}
            <table class="table table-striped table-bordered table-hover" cellspacing="0" cellpadding="0">
                <tr>
                    <th>Наименование</th>
                    <th>Цена</th>
                    <th>Оплата</th>
                    <th>Скидка</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
                {foreach from=$purchasedTickets item=ticket}
                    {assign var=basketId value=$ticket.id}
                    {assign var=basketStatus value=$ticket.status}
                    {assign var=basketUserId value=$ticket.userId}
                    {assign var=basketChildId value=$ticket.childId}
                    {capture name=capturedBasketUserIdChildId}{$basketUserId}_{if $basketChildId}{$basketChildId}{/if}{/capture}
                    {assign var=basketUserIdChildId value=$smarty.capture.capturedBasketUserIdChildId}
                    <tr>
                        <td style="width: 50%;">Билет &laquo;{$ticket.baseTicketName}&raquo;</td>
                        <td>{$ticket.needAmount|round0}</td>
                        <td>{$ticket.payAmount+$ticket.ulAmount|round0}</td>
                        <td>{$ticket.discountAmount|round0}</td>
                        <td>{$this.basketStatuses.$basketStatus}</td>
                        <td>
                            {if ($ticket.needAmount-$ticket.payAmount-$ticket.ulAmount+$ticket.returnedAmount-$ticket.discountAmount) > 0}
                                {assign var=total value=$total+$ticket.needAmount-$ticket.payAmount-$ticket.ulAmount+$ticket.returnedAmount-$ticket.discountAmount}
                            {/if}
                            {if $basketStatus == 'STATUS_NEW'}<a href="{alink do=adminmarkticketpaid basketId=$basketId}" onclick="return confirm('Вы уверены что нужно отметить эту позицию как оплаченную?');">Отметить что оплачено</a>{else}-{/if}
                        </td>
                    </tr>
                {/foreach}
            </table>
            {/if}

            {if $purchasedProducts}
            <p class="mk-title">Мастер-классы, ужины:</p>
            <table class="table table-striped table-bordered table-hover" cellspacing="0" cellpadding="0">
                <tr>
                    <th>Наименование</th>
                    <th>Цена</th>
                    <th>Оплата</th>
                    <th>Скидка</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
                {foreach from=$purchasedProducts item=product}
                    {assign var=basketProductId value=$product.id}
                    {assign var=basketStatus value=$product.status}
                    {assign var=basketUserId value=$product.userId}
                    {assign var=basketChildId value=$product.childId}
                    {capture name=capturedBasketUserIdChildId}{$basketUserId}_{if $basketChildId}{$basketChildId}{/if}{/capture}
                    {assign var=basketUserIdChildId value=$smarty.capture.capturedBasketUserIdChildId}
                    <tr>
                        <td style="width: 50%;">{$product.productName}</td>
                        <td>{$product.needAmount|round0}</td>
                        <td>{$product.payAmount+$product.ulAmount|round0}</td>
                        <td>{$product.discountAmount|round0}</td>
                        <td>{$this.basketProductStatuses.$basketStatus}</td>
                        <td>
                            {if ($product.needAmount-$product.payAmount-$product.ulAmount+$product.returnedAmount-$product.discountAmount) > 0}
                                {assign var=total value=$total+$product.needAmount-$product.payAmount-$product.ulAmount+$product.returnedAmount-$product.discountAmount}
                            {/if}
                            {if $basketStatus == 'STATUS_NEW'}<a href="{alink do=adminmarkproductpaid basketProductId=$basketProductId}" onclick="return confirm('Вы уверены что нужно отметить эту позицию как оплаченную?');">Отметить что оплачено</a>{else}-{/if}
                        </td>
                    </tr>
                {/foreach}
            </table>
            {/if}
            <br/>
        {/foreach}
    {/if}

</div>


{if $this.bomList}
    <h3>Бронирования:</h3>
    <table class="table table-striped table-bordered table-hover" cellspacing="0" cellpadding="0">
        <tr>
            <th>ID</th>
            <th>Дата оплаты</th>
            <th>Забронировано до</th>
            <th>Оплачено</th>
        </tr>
        {foreach from=$this.bomList item=bom}
            <tr>
                <td>{$bom->id}</td>
                <td>{$bom->tsPay|dateformat:'d.m.Y, в H:i'}</td>
                <td>{$bom->tsFinish|dateformat:'d.m.Y, в H:i'}</td>
                <td>{$bom->payAmount|round0}</td>
            </tr>
        {/foreach}
    </table>
{/if}